#!/usr/bin/env bash
set -e

# Utility functions
info() { echo "[INFO] $*"; }
err()  { echo "[ERROR] $*" >&2; rm -f "$TMPFILE" "$OUTFILE"; exit 1; }

# Detect environment
UNAME=$(uname -s)
case "$UNAME" in
  *MINGW*|*MSYS*|*CYGWIN*)
    PLATFORM="windows"
    ;;
  *)
    PLATFORM="linux"
    ;;
esac
info "Detected platform: $PLATFORM"

# Compiler detection
CXX=${CXX:-g++}
command -v "$CXX" >/dev/null 2>&1 || err "g++ not found in PATH"
info "Detected compiler: $CXX"

# Check for C++23 support
info "Checking for C++23 support..."
TMPFILE="$(mktemp testcppXXXX.cpp)"
cat > "$TMPFILE" <<'EOF'
#if __cplusplus < 202002L
#error "C++23 not supported"
#endif
int main() { return 0; }
EOF
OUTFILE="$(mktemp testoutXXXX.exe)"
if "$CXX" -std=c++23 -o "$OUTFILE" "$TMPFILE" >"$OUTFILE" 2>&1; then
  info "Compiler supports C++23"
else
  err "Compiler does not support -std=c++23. Please upgrade your compiler."
fi

info "Checking for <ranges> support..."
cat > "$TMPFILE" <<'EOF'
#include <ranges>
#include <vector>
int main() {
  auto v = std::views::iota(0, 3)
  | std::ranges::to<std::vector>();
}
EOF
if "$CXX" -std=c++23 -o "$OUTFILE" "$TMPFILE" >"$OUTFILE" 2>&1; then
  info "Compiler supports <ranges> library"
else
  err "No support found for <ranges> library. Please upgrade your compiler."
fi
rm -f "$TMPFILE" "$OUTFILE"

# pkg-config and dependencies
command -v pkg-config >/dev/null 2>&1 || err "pkg-config not found"
info "Checking for gtkmm >= 4.0..."
pkg-config --exists 'gtkmm-4.0 >= 4.0' || err "gtkmm >= 4.0 is required"
info "Found gtkmm-4.0"

info "Checking for epoxy..."
pkg-config --exists 'epoxy' || err "libepoxy is required"
info "Found libepoxy"

# Check for OpenGL headers
if [ "$PLATFORM" = "windows" ]; then
  GL_HEADERS="/mingw64/include/GL/gl.h"
else
  GL_HEADERS="/usr/include/GL/gl.h"
fi

FOUND_GL=0
for hdr in $GL_HEADERS; do
  if [ -f "$hdr" ]; then
    info "Found OpenGL header: $hdr"
    FOUND_GL=1
    break
  fi
done

[ $FOUND_GL -eq 1 ] || err "OpenGL headers not found!"

# -------------------------
#   VTK SUPPORT
# -------------------------
info "Checking for VTK..."
if [ "$PLATFORM" = "windows" ]; then
    VTK_INC_DIR="C:/msys64/mingw64/include/vtk"
    VTK_LIB_DIR="C:/msys64/mingw64/lib/vtk/hierarchy/VTK"
else
    VTK_INC_DIR="/usr/include/vtk"
    VTK_LIB_DIR="/usr/lib"
fi

if [ -d "$VTK_INC_DIR" ] && [ -d "$VTK_LIB_DIR" ]; then
    info "✓ Found VTK include: $VTK_INC_DIR"
    info "✓ Found VTK lib:     $VTK_LIB_DIR"
else
    err "VTK not found! Please update VTK paths in configure script."
fi

VTK_LIBS="-lvtkCommonCore -lvtkCommonDataModel -lvtkCommonSystem -lvtkCommonMisc -lvtkViewsCore -lvtkRenderingOpenGL2 -lvtkViewsInfovis -lvtkRenderingCore -lvtkInteractionStyle -lvtksys -lvtkChartsCore -lvtkRenderingContext2D -lvtkRenderingContextOpenGL2 -lvtkInteractionWidgets -lvtkViewsContext2D -lvtkRenderingFreeType -lvtkRenderingUI"

# Build flags
GTK_CFLAGS=$(pkg-config --cflags gtkmm-4.0 epoxy)
GTK_LIBS=$(pkg-config --libs gtkmm-4.0 epoxy)
COMMON_FLAGS="-Wall -std=c++23 -MMD -MP -Isrc/include -I$VTK_INC_DIR $GTK_CFLAGS"
LINK_FLAGS="$GTK_LIBS -L$VTK_LIB_DIR $VTK_LIBS"

# Makefile generation
cat > Makefile <<'EOF'
# Auto-generated Makefile by configure
CXX := @CXX@
SRC_DIR := src
BUILD_DIR := build
BIN := mvf

SRCS := $(shell find $(SRC_DIR) -type f -name '*.cpp')
OBJS := $(addprefix $(BUILD_DIR)/,$(subst /,_,$(SRCS:$(SRC_DIR)/%.cpp=%.o)))
DEPS := $(OBJS:.o=.d)

CXXFLAGS := @CXXFLAGS@
LDFLAGS := @LDFLAGS@
PLATFORM := @PLATFORM@

ifeq ($(filter debug,$(MAKECMDGOALS)),debug)
	CXXFLAGS += -O0 -g -DMVF_DEBUG
else
	CXXFLAGS += -O3
	ifeq ($(PLATFORM),windows)
		LDFLAGS += -mwindows
	endif
endif

.PHONY: all clean debug release

all: release

debug: $(BIN)

release: $(BIN)

$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

$(foreach src,$(SRCS),\
  $(eval \
    obj := $(BUILD_DIR)/$(subst /,_,$(patsubst $(SRC_DIR)/%.cpp,%.o,$(src))) \
  )\
  $(eval \
    $(obj): $(src) | $(BUILD_DIR); \
        @echo "Compiling $(src)"; \
        echo $(CXX) $(CXXFLAGS) -c $(src) -o $(obj);\
        $(CXX) $(CXXFLAGS) -c $(src) -o $(obj) \
  )\
)

ifeq ($(PLATFORM),windows)
ICON_RES := $(BUILD_DIR)/icon_res.o
$(ICON_RES): assets/icon.rc | $(BUILD_DIR)
	@echo "Compiling Windows icon resource"
	@windres assets/icon.rc -O coff -o $(ICON_RES)
OBJS += $(ICON_RES)
endif

$(BIN): $(OBJS)
	@echo "Linking $(BIN)"
	$(CXX) $(OBJS) -o $(BIN) $(LDFLAGS)

clean:
	@echo "Cleaning..."
	@rm -rf $(BUILD_DIR) $(BIN)

-include $(DEPS)
EOF

# Substitute variables into Makefile
sed -i "s|@CXX@|$CXX|g" Makefile
sed -i "s|@CXXFLAGS@|$COMMON_FLAGS|g" Makefile
sed -i "s|@LDFLAGS@|$LINK_FLAGS|g" Makefile
sed -i "s|@PLATFORM@|$PLATFORM|g" Makefile

info "Makefile created successfully!"
info "Now run 'make' (for release) or 'make debug'."
