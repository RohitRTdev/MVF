#!/usr/bin/env bash
set -e

# Utility functions
info() { echo "[INFO] $*"; }
err()  { 
  echo "[ERROR] $1" >&2
  rm -f "$TMPFILE" "$OUTFILE"
  if [ $2 -eq 1 ]; then 
    exit 1
  fi
}

check_compiler_support() {
  if ! command -v "$1" >/dev/null 2>&1; then
    err "$1 not found in PATH" 0
    return 1
  fi

  info "Detected compiler: $1"

  info "Checking for C++23 support..."
  TMPFILE="$(mktemp testcppXXXXXX.cpp)"
  OUTFILE="$(mktemp testoutXXXX.exe)"
  cat > "$TMPFILE" <<'EOF'
#if __cplusplus < 202002L
#error "C++23 not supported"
#endif
int main() { return 0; }
EOF
  
  if "$1" -std=c++23 -o "$OUTFILE" "$TMPFILE" >"$OUTFILE" 2>&1; then
    info "Compiler supports C++23"
  else
    err "Compiler does not support -std=c++23" 0
    return 1
  fi

  info "Checking for <ranges> support..."
  cat > "$TMPFILE" <<'EOF'
#include <ranges>
#include <vector>
int main() {
  auto v = std::views::iota(0, 3)
  | std::ranges::to<std::vector>();
}
EOF

  if "$1" -std=c++23 -o "$OUTFILE" "$TMPFILE" >"$OUTFILE" 2>&1; then
    info "Compiler supports <ranges> library"
  else
    err "Compiler doesn't provide <ranges> library" 0
    return 1
  fi

  rm -f "$TMPFILE" "$OUTFILE"
  return 0
}


# Detect environment
UNAME=$(uname -s)
case "$UNAME" in
  *MINGW*|*MSYS*|*CYGWIN*)
    PLATFORM="windows"
    ;;
  *)
    PLATFORM="linux"
    ;;
esac

info "Detected platform: $PLATFORM"

# Feel free to add more
CXX_LIST="g++ g++-14 NULL"

# Testing available compilers
for compiler in $CXX_LIST; do 
  if [ "$compiler" = "NULL" ]; then
    err "No compatible compilers found..." 1
  fi
  info "Testing compiler $compiler"
  if check_compiler_support $compiler; then
    CXX=$compiler
    break
  fi

done

# pkg-config and dependencies
command -v pkg-config >/dev/null 2>&1 || err "pkg-config not found" 1

info "Checking for gtkmm-4.0..."
pkg-config --exists 'gtkmm-4.0 >= 4.10' || err "gtkmm >= 4.10 is required" 1
info "Found gtkmm-4.0"

info "Checking for epoxy..."
pkg-config --exists 'epoxy' || err "libepoxy is required" 1
info "Found libepoxy"

# Check for OpenGL headers
# For now, we just check these locations. Feel free to add more...
if [ "$PLATFORM" = "windows" ]; then
  GL_HEADERS="/mingw64/include/GL/gl.h"
else
  GL_HEADERS="/usr/include/GL/gl.h"
fi

FOUND_GL=0
for hdr in $GL_HEADERS; do
  if [ -f "$hdr" ]; then
    info "Found OpenGL header: $hdr"
    FOUND_GL=1
    break
  fi
done

[ $FOUND_GL -eq 1 ] || err "OpenGL headers not found!" 1

# Build flags
GTK_CFLAGS=$(pkg-config --cflags gtkmm-4.0 epoxy)
GTK_LIBS=$(pkg-config --libs gtkmm-4.0 epoxy)
COMMON_FLAGS="-Wall -std=c++23 -MMD -MP -Isrc/include $GTK_CFLAGS"
LINK_FLAGS="$GTK_LIBS"

# Makefile generation
cat > Makefile <<'EOF'
# Auto-generated Makefile by configure
CXX := @CXX@
SRC_DIR := src
BUILD_DIR := build
BIN := mvf

SRCS := $(shell find $(SRC_DIR) -type f -name '*.cpp')
OBJS := $(addprefix $(BUILD_DIR)/,$(subst /,_,$(SRCS:$(SRC_DIR)/%.cpp=%.o)))
DEPS := $(OBJS:.o=.d)

CXXFLAGS := @CXXFLAGS@
LDFLAGS := @LDFLAGS@
PLATFORM := @PLATFORM@

ifeq ($(filter debug,$(MAKECMDGOALS)),debug)
	CXXFLAGS += -O0 -g -DMVF_DEBUG
else
	CXXFLAGS += -O3
	ifeq ($(PLATFORM),windows)
		LDFLAGS += -mwindows
	endif
endif

.PHONY: all clean debug release

all: release

debug: $(BIN)

release: $(BIN)

$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

$(foreach src,$(SRCS),\
  $(eval \
    obj := $(BUILD_DIR)/$(subst /,_,$(patsubst $(SRC_DIR)/%.cpp,%.o,$(src))) \
  )\
  $(eval \
    $(obj): $(src) | $(BUILD_DIR); \
        @echo "Compiling $(src)"; \
        echo $(CXX) $(CXXFLAGS) -c $(src) -o $(obj);\
        $(CXX) $(CXXFLAGS) -c $(src) -o $(obj) \
  )\
)

ifeq ($(PLATFORM),windows)
ICON_RES := $(BUILD_DIR)/icon_res.o
$(ICON_RES): assets/icon.rc | $(BUILD_DIR)
	@echo "Compiling Windows icon resource"
	@windres assets/icon.rc -O coff -o $(ICON_RES)
OBJS += $(ICON_RES)
endif

$(BIN): $(OBJS)
	@echo "Linking $(BIN)"
	$(CXX) $(OBJS) -o $(BIN) $(LDFLAGS)

clean:
	@echo "Cleaning..."
	@rm -rf $(BUILD_DIR) $(BIN)

-include $(DEPS)
EOF

# Substitute variables into Makefile
sed -i "s|@CXX@|$CXX|g" Makefile
sed -i "s|@CXXFLAGS@|$COMMON_FLAGS|g" Makefile
sed -i "s|@LDFLAGS@|$LINK_FLAGS|g" Makefile
sed -i "s|@PLATFORM@|$PLATFORM|g" Makefile

info "Makefile created successfully!"
info "Now run 'make' (for release) or 'make debug'."
